<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOGIKART</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <img src="logikart-logo.png" alt="LOGIKART" class="logo"/>
    <h1 id="pageTitle">LOGIKART - Réseau de prestataires informatiques</h1>
    <button id="burgerMenu" aria-label="menu">☰</button>
  </header>

  <main>
    <!-- Barre d’actions -->
    <section id="actions" class="actions">
      <div class="actions-row">
        <div class="actions-left">
          <button onclick="openProviderForm()">Ajouter un prestataire</button>
          <button onclick="openImportModal()">Importer</button>
          <button onclick="exportProviders('json')">Exporter JSON</button>
          <button onclick="exportProviders('csv')">Exporter CSV</button>
        </div>
        <div class="actions-right">
          <input id="cityInput" type="text" placeholder="Ville pour recherche de proximité"/>
          <button onclick="searchNearest()">Rechercher le plus proche</button>
          <button onclick="openItineraryTool()">Calculer un itinéraire</button>
          <button onclick="openReportForm()">Imprimer rapport d’intervention</button>
        </div>
      </div>
    </section>

    <!-- Layout: liste + carte -->
    <section class="layout">
      <aside class="list-panel">
        <h2>Prestataires</h2>
        <div id="providerList" class="provider-list"></div>
      </aside>
      <section class="map-panel">
        <div id="map"></div>
      </section>
    </section>
  </main>

  <!-- Modal : Formulaire prestataire -->
  <div id="providerFormSection" class="modal">
    <div class="modal-content">
      <span class="close" onclick="hideForm()">&times;</span>
      <h3>Ajouter / Modifier un prestataire</h3>
      <form id="providerForm">
        <label>Raison sociale
          <input id="companyName" type="text" required />
        </label>
        <label>Nom
          <input id="contactName" type="text" />
        </label>
        <label>Prénom
          <input id="firstName" type="text" />
        </label>
        <label>Adresse
          <input id="address" type="text" required/>
        </label>
        <label>Email
          <input id="email" type="email" />
        </label>
        <label>Téléphone
          <input id="phone" type="text" />
        </label>
        <label>Tarif horaire HT (€)
          <input id="rate" type="number" step="0.01" />
        </label>
        <label>Frais déplacement HT (€)
          <input id="travelFees" type="number" step="0.01" />
        </label>
        <label>Total HT (automatique si vide)
          <input id="totalCost" type="text" />
        </label>

        <div class="form-actions">
          <button type="submit">Enregistrer</button>
          <button type="button" onclick="hideForm()">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal : Import -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeImportModal()">&times;</span>
      <h3>Importer des prestataires</h3>
      <p>Fichier JSON ou CSV (avec en-têtes).</p>
      <input id="importFile" type="file" accept=".json,.csv" />
      <label style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <input type="checkbox" id="skipDuplicates" checked />
        Ignorer doublons (même email+phone)
      </label>
      <div class="form-actions">
        <button type="button" onclick="handleImport()">Importer</button>
        <button type="button" onclick="closeImportModal()">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modal : Itinéraire -->
  <div id="itineraryModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeItineraryModal()">&times;</span>
      <h2>Calcul d'itinéraire</h2>
      <form id="itineraryForm" onsubmit="event.preventDefault(); calculateRoute();">
        <label>Départ
          <input type="text" id="startAddress" placeholder="Adresse de départ" />
        </label>

        <div id="extraDestinations"></div>

        <label>Arrivée
          <input type="text" id="endAddress" placeholder="Adresse d'arrivée" />
        </label>

        <div class="itinerary-actions">
          <button type="button" onclick="addDestinationField()">Ajouter une étape</button>
          <button type="submit">Calculer l'itinéraire</button>
          <button type="button" id="exportPdfBtn" style="display:none" onclick="exportItineraryToPDF()">Exporter en PDF</button>
        </div>

        <div id="routeResult"></div>
      </form>
    </div>
  </div>

  <!-- Modal : Rapport d’intervention -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeReportForm()">&times;</span>
      <h2>Rapport d’intervention</h2>
      <form id="reportForm">
        <label>N° Ticket <input type="text" name="ticket"></label>
        <label>Date <input type="date" name="interventionDate"></label>
        <label>Adresse du site <input type="text" name="siteAddress"></label>
        <label>Technicien <input list="technicianList" type="text" name="technician"></label>
        <datalist id="technicianList"></datalist>
        <label>Travaux à réaliser <textarea name="todo"></textarea></label>
        <label>Travaux réalisés <textarea name="done"></textarea></label>
        <div class="two">
          <label>Heure de début <input type="time" name="start"></label>
          <label>Heure de fin <input type="time" name="end"></label>
        </div>
        <div class="two">
          <label>Signature technicien <input type="text" name="signTech"></label>
          <label>Signature client <input type="text" name="signClient"></label>
        </div>
        <div class="report-actions">
          <button type="button" onclick="printReport()">Imprimer</button>
          <button type="button" onclick="generatePDF()">Générer PDF</button>
        </div>
      </form>
      <div id="reportContent"></div>
    </div>
  </div>

  <!-- Leaflet JS & Leaflet Image (pour export itinéraire si besoin) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

  <!-- html2pdf (optionnel; on n’en dépend plus pour le PDF du rapport) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js" defer></script>

  <script src="script.js"></script>
</body>
</html>
