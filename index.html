<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOGIKART - Carte des Prestataires</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="logikart-logo.png" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- (Optionnel) MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <!-- Styles correctifs -->
  <style>
    /* En-t√™te */
    header {
      position: sticky; top: 0; z-index: 3000;
      background: #004080; color: #fff;
      padding: 20px 12px 12px;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      text-align: center;
    }
    header h1 { margin: 0; font-size: 20px; font-weight: 600; color:#fff !important; }

    /* Burger TOUJOURS au-dessus */
    #burgerMenu{
      position: fixed !important; top:12px !important; right:12px !important;
      user-select:none; cursor:pointer; font-size:20px;
      background:#fff; color:#000; border:1px solid #eee; border-radius:8px;
      padding:6px 10px; line-height:1; z-index: 2147483647 !important;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
    }
    #menuDropdown{
      position: fixed !important; top:56px !important; right:12px !important;
      display:none; z-index: 2147483646 !important;
      background:#fff; border:1px solid #eee; border-radius:8px;
      padding:6px 0; min-width:240px; box-shadow:0 6px 20px rgba(0,0,0,.12);
    }
    #menuDropdown ul{ list-style:none; margin:0; padding:0; }
    #menuDropdown li{ padding:10px 14px; cursor:pointer; }
    #menuDropdown li:hover{ background:#f6f6f6; }
    #menuDropdown li.divider{ border-top:1px solid #eee; margin:6px 0 0 0; padding:0; }

    /* Carte & page */
    body, html { height:100%; }
    #map { width:100%; height:80vh; }

    /* Panneau Prestataires : panneau lat√©ral fixe */
    #providerList {
      display:none;
      position: fixed; top: 120px; right: 12px; z-index: 3500;
      width: min(380px, 92vw); max-height: 60vh; overflow:auto;
      background:#fff; border:1px solid #ddd; border-radius:10px; padding:12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
    }

    /* Modals g√©n√©riques */
    .modal, .modal-overlay {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);
      align-items:center; justify-content:center; z-index:2000;
    }
    .modal-content{
      background:#fff; padding:16px; border-radius:12px;
      max-width:720px; width:min(92vw,720px); max-height:85vh; overflow:auto;
    }
    .form-buttons{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Itin√©raire : boutons c√¥te √† c√¥te */
    #itineraryForm .controls-row {
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
      margin-top: 10px;
    }
    #itineraryForm .full { width:100%; }

    /* Zone d‚Äôimpression/PDF (DOIT √™tre visible pour html2pdf) */
    #reportPrint {
      position: fixed; left: -9999px; top: 0;   /* hors √©cran mais rendu */
      width: 794px; /* A4 portrait ~ 210mm @96dpi ‚âà 794px */
      background: #fff; color:#000; padding: 24px;
      z-index: -1;
    }
    #reportPrint h2 { margin: 0 0 8px; }
    #reportPrint .row { display:flex; gap:12px; }
    #reportPrint .row > div { flex:1; }
    #reportPrint table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    #reportPrint table td, #reportPrint table th { border:1px solid #ddd; padding:8px; vertical-align: top; }
  </style>
</head>

<body>
  <!-- En-t√™te -->
  <header>
    <img src="logikart-logo.png" alt="LOGIKART" style="height:60px;" />
    <h1>LOGIKART - Carte des Prestataires</h1>
  </header>

  <!-- Burger -->
  <div
    id="burgerMenu"
    role="button"
    tabindex="0"
    aria-haspopup="true"
    aria-expanded="false"
    aria-controls="menuDropdown"
    onclick="window.__toggleMenu && window.__toggleMenu(event)"
  >‚ò∞</div>

  <div id="menuDropdown" aria-label="Menu">
    <ul>
      <li onclick="toggleProviderList()">üìã Prestataires</li>
      <li onclick="openItineraryTool()">üß≠ Calculer un itin√©raire</li>
      <li onclick="openReportForm()">üìù Imprimer rapport d‚Äôintervention</li>
      <li class="divider"></li>
      <li onclick="exportProviders('json')">‚¨áÔ∏è Exporter (JSON)</li>
      <li onclick="exportProviders('csv')">‚¨áÔ∏è Exporter (CSV)</li>
      <li onclick="openImportModal()">‚¨ÜÔ∏è Importer</li>
    </ul>
  </div>

  <!-- Script DU BURGER (autonome) -->
  <script>
    (function () {
      const burger = document.getElementById('burgerMenu');
      const dropdown = document.getElementById('menuDropdown');
      function closeMenu(){ dropdown.style.display='none'; burger.setAttribute('aria-expanded','false'); }
      function toggleMenu(e){ if(e) e.stopPropagation(); const open=dropdown.style.display==='block'; dropdown.style.display=open?'none':'block'; burger.setAttribute('aria-expanded', String(!open)); }
      window.__toggleMenu = toggleMenu;
      burger.addEventListener('click', toggleMenu);
      burger.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleMenu(e);} });
      dropdown.addEventListener('click', (e)=> e.stopPropagation());
      document.addEventListener('click', (e)=>{ if(!dropdown.contains(e.target) && e.target!==burger) closeMenu(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
    })();
  </script>

  <!-- Barre d‚Äôaction -->
  <section style="padding:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
    <input type="text" id="cityInput" placeholder="Ville" style="width:260px; padding:8px; border:1px solid #ccc; border-radius:6px;" />
    <button onclick="searchNearest()">Rechercher</button>
    <button onclick="addProvider()">Ajouter un prestataire</button>
  </section>

  <!-- Carte -->
  <div id="map"></div>

  <!-- Panneau Prestataires -->
  <aside id="providerList"></aside>

  <!-- ===== Modal Prestataire ===== -->
  <div id="providerFormSection" class="modal-overlay">
    <div class="modal-content">
      <form id="providerForm">
        <h2>Ajouter un prestataire</h2>
        <input type="text" id="companyName" placeholder="RAISON SOCIALE" required />
        <input type="text" id="contactName" placeholder="NOM" required />
        <input type="text" id="firstName" placeholder="PR√âNOM" />
        <input type="text" id="address" placeholder="ADRESSE POSTALE" required />
        <input type="email" id="email" placeholder="ADRESSE EMAIL" />
        <input type="tel" id="phone" placeholder="N¬∞ DE T√âL√âPHONE" />
        <input type="number" id="rate" placeholder="Tarif heure HT (‚Ç¨)" step="0.01" />
        <input type="number" id="travelFees" placeholder="Frais de d√©placement HT (‚Ç¨)" step="0.01" />
        <input type="text" id="totalCost" placeholder="Tarif total HT (‚Ç¨)" readonly />
        <div class="form-buttons">
          <button type="submit">Enregistrer</button>
          <button type="button" onclick="hideForm()">Annuler</button>
        </div>
      </form>
      <script>
        // Calcul auto du total HT
        const rateInput = document.getElementById("rate");
        const travelInput = document.getElementById("travelFees");
        const totalInput = document.getElementById("totalCost");
        function updateTotal(){ const r=parseFloat(rateInput.value)||0, t=parseFloat(travelInput.value)||0; totalInput.value=(r+t).toFixed(2)+' ‚Ç¨'; }
        rateInput.addEventListener("input", updateTotal);
        travelInput.addEventListener("input", updateTotal);
      </script>
    </div>
  </div>

  <!-- ===== Modal Rapport d‚Äôintervention (UN SEUL) ===== -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeReportForm()">√ó</span>
      <form id="reportForm">
        <img src="logikart-logo.png" alt="LOGIKART" class="logo" style="height:60px;" />
        <h2>Rapport d‚Äôintervention LOGIKART</h2>
        <label>Num√©ro de ticket :</label>
        <input type="text" name="ticket" required />
        <label>Date d‚Äôintervention :</label>
        <input type="date" name="interventionDate" required />
        <label>Adresse du site :</label>
        <input type="text" name="siteAddress" required />
        <label>Nom du technicien :</label>
        <input type="text" name="technician" list="technicianList" required />
        <datalist id="technicianList"></datalist>
        <label>Travail √† faire :</label>
        <textarea name="todo" rows="6" required></textarea>
        <label>Travail effectu√© :</label>
        <textarea name="done" rows="10" required></textarea>
        <label>Heure d‚Äôarriv√©e :</label>
        <input type="time" name="start" required />
        <label>Heure de d√©part :</label>
        <input type="time" name="end" required />
        <label>Signature du technicien :</label>
        <input type="text" name="signTech" />
        <label>Signature du client :</label>
        <input type="text" name="signClient" />
        <div class="form-buttons">
          <button type="button" onclick="printReport()">üñ®Ô∏è Imprimer</button>
          <button type="button" onclick="generatePDF()">üìÑ G√©n√©rer PDF</button>
          <button type="button" onclick="closeReportForm()">‚ùå Fermer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Zone d‚Äôimpression/PDF (visible hors √©cran) ===== -->
  <div id="reportPrint"></div>

  <!-- ===== Modal Itin√©raire ===== -->
  <div id="itineraryModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeItineraryModal()">√ó</span>
      <h2>üß≠ Calcul d'itin√©raire</h2>
      <form id="itineraryForm" onsubmit="return false;">
        <label class="full">Adresse de d√©part :</label>
        <input class="full" type="text" id="startAddress" required />

        <div id="extraDestinations" class="full"></div>

        <label class="full">Adresse de destination :</label>
        <input class="full" type="text" id="endAddress" required />

        <div class="controls-row">
          <button id="addStepBtn" type="button" onclick="addDestinationField()">‚ûï Ajouter une √©tape</button>
          <button type="button" onclick="calculateRoute()">üöó Calculer l‚Äôitin√©raire</button>
          <button id="exportPdfBtn" type="button" onclick="exportItineraryToPDF()" style="display:none;">üìÑ Exporter en PDF</button>
        </div>
      </form>
      <div id="routeResult" style="margin-top:15px;"></div>
    </div>
  </div>

  <!-- ===== Modal Import ===== -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeImportModal()">√ó</span>
      <h2>‚ÜïÔ∏è Importer des prestataires</h2>
      <p>Fichiers accept√©s : <strong>JSON</strong> ou <strong>CSV</strong> (ent√™tes FR/EN reconnus).</p>
      <input type="file" id="importFile" accept=".json,.csv" />
      <label style="display:block; margin-top:8px;">
        <input type="checkbox" id="skipDuplicates" checked />
        Ignorer les doublons (m√™me email + t√©l√©phone)
      </label>
      <div class="form-buttons" style="margin-top:12px;">
        <button type="button" onclick="handleImport()">Importer</button>
        <button type="button" onclick="closeImportModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- (Optionnel) MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- Initialisation Firebase + Auth anonyme -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA59iB-7skqRFngoF24VkAHZMBSIonh7Ho",
      authDomain: "lgk-presta.firebaseapp.com",
      projectId: "lgk-presta",
      storageBucket: "lgk-presta.firebasestorage.app",
      messagingSenderId: "386610630784",
      appId: "1:386610630784:web:015bb6c04156918d369665"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    window.db = db;

    // Promise d‚Äôauth anonyme utilis√©e par script.js
    window.authReady = (async () => {
      try {
        if (auth.setPersistence) {
          await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
        }
      } catch (e) {
        console.warn("[Auth] setPersistence:", e?.message || e);
      }
      try {
        await auth.signInAnonymously();
        console.log("[Auth] Connect√© anonymement");
      } catch (e) {
        console.warn("[Auth] Echec connexion anonyme:", e);
      }
    })();
  </script>

  <!-- PDF & rendu de carte -->
  <!-- ‚ö†Ô∏è Garder UNIQUEMENT html2pdf.bundle (n‚Äôajoute PAS html2canvas s√©par√©, sinon PDF blanc) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

  <!-- Script principal -->
  <script src="script.js"></script>

  <!-- Correctifs rapport : d√©doublonnage + PDF non vierge -->
  <script>
    // 1) Si un vieux doublon du modal rapport existe dans la page, on le supprime
    document.addEventListener('DOMContentLoaded', () => {
      const modals = document.querySelectorAll('#reportModal');
      if (modals.length > 1) {
        for (let i = 1; i < modals.length; i++) modals[i].remove();
      }
    });

    // 2) Fonctions robustes pour ouvrir/fermer le modal
    window.openReportForm = function () {
      const modal = document.getElementById('reportModal');
      if (modal) { modal.style.display = 'flex'; }
    };
    window.closeReportForm = function () {
      const modal = document.getElementById('reportModal');
      if (modal) { modal.style.display = 'none'; }
    };

    // 3) Gabarit d‚Äôimpression & PDF (rendu visible hors √©cran pour √©viter le PDF blanc)
    function buildReportHTML(values) {
      return `
        <div>
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
            <img src="logikart-logo.png" alt="LOGIKART" style="height:54px;" />
            <h2 style="margin:0;">Rapport d‚Äôintervention LOGIKART</h2>
          </div>

          <div class="row">
            <div><strong>N¬∞ Ticket :</strong> ${values.ticket}</div>
            <div><strong>Date :</strong> ${values.interventionDate}</div>
          </div>
          <div class="row" style="margin-top:6px;">
            <div><strong>Technicien :</strong> ${values.technician}</div>
            <div><strong>Site :</strong> ${values.siteAddress}</div>
          </div>

          <table>
            <tr><th>Travail √† faire</th></tr>
            <tr><td>${values.todo.replace(/\n/g,'<br>')}</td></tr>
          </table>

          <table>
            <tr><th>Travail effectu√©</th></tr>
            <tr><td>${values.done.replace(/\n/g,'<br>')}</td></tr>
          </table>

          <div class="row" style="margin-top:12px;">
            <div><strong>Arriv√©e :</strong> ${values.start}</div>
            <div><strong>D√©part :</strong> ${values.end}</div>
          </div>

          <div class="row" style="margin-top:16px;">
            <div><strong>Signature technicien :</strong> ${values.signTech || ''}</div>
            <div><strong>Signature client :</strong> ${values.signClient || ''}</div>
          </div>
        </div>
      `;
    }

    function getReportValues() {
      const f = document.getElementById('reportForm');
      const get = (name) => (f.querySelector(\`[name="\${name}"]\`)?.value || '').trim();
      return {
        ticket: get('ticket'),
        interventionDate: get('interventionDate'),
        siteAddress: get('siteAddress'),
        technician: get('technician'),
        todo: get('todo'),
        done: get('done'),
        start: get('start'),
        end: get('end'),
        signTech: get('signTech'),
        signClient: get('signClient'),
      };
    }

    window.printReport = function () {
      const container = document.getElementById('reportPrint');
      container.innerHTML = buildReportHTML(getReportValues());
      const prev = document.body.innerHTML;
      const prevScroll = { x: window.scrollX, y: window.scrollY };
      document.body.innerHTML = container.outerHTML;
      window.print();
      document.body.innerHTML = prev;
      window.scrollTo(prevScroll.x, prevScroll.y);
    };

    window.generatePDF = async function () {
      const container = document.getElementById('reportPrint');
      container.innerHTML = buildReportHTML(getReportValues());

      // html2pdf fonctionne sur un √©l√©ment VISIBLE (ici: hors √©cran mais rendu)
      const opt = {
        margin:       10,               // mm
        filename:     'rapport_intervention.pdf',
        image:        { type: 'jpeg', quality: 0.95 },
        html2canvas:  { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      await html2pdf().set(opt).from(container).save();
    };
  </script>
</body>
</html>
