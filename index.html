<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LOGIKART – Prestataires</title>

  <!-- Styles -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* Sécurité: burger toujours en haut-droite même sans CSS externe */
    header { position: relative; }
    #burgerMenu { position: absolute; top: 12px; right: 12px; z-index: 1000; }
    #menuDropdown { position: absolute; right: 12px; top: 48px; display:none; z-index: 1000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; min-width: 220px; box-shadow: 0 8px 24px rgba(0,0,0,.12); }
    #menuDropdown button, #menuDropdown a { width:100%; display:block; text-align:left; margin:4px 0; }
    body, html { height: 100%; }
    main { height: calc(100% - 56px); }
    #map { width: 100%; height: 60vh; }
    #providerList { max-height: 32vh; overflow: auto; }
    .modal {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);
      align-items:center; justify-content:center; z-index:2000;
    }
    .modal .card {
      background:#fff; padding:16px; border-radius:12px; max-width: 720px; width: min(92vw, 720px);
      max-height: 85vh; overflow:auto;
    }
    .row { display:flex; gap:8px; }
    .row > * { flex: 1; }
    .provider-entry { padding: 8px 0; }
  </style>
</head>
<body>
  <header>
    <img src="logikart-logo.png" alt="LOGIKART" style="height:40px; margin:8px 12px;">
    <button id="burgerMenu">☰</button>
    <div id="menuDropdown">
      <button onclick="openImportModal()">📥 Importer</button>
      <div class="row">
        <button onclick="exportProviders('json')">📤 Export JSON</button>
        <button onclick="exportProviders('csv')">📤 Export CSV</button>
      </div>
      <hr>
      <button onclick="openReportForm()">📝 Rapport d’intervention</button>
      <button onclick="openItineraryTool()">🧭 Itinéraire</button>
      <hr>
      <button onclick="toggleProviderList()">👁️ Afficher/Masquer la liste</button>
      <button onclick="addProvider()">➕ Ajouter un prestataire</button>
    </div>
  </header>

  <main>
    <!-- Recherche de proximité -->
    <section style="padding:8px 12px;">
      <div class="row">
        <input id="cityInput" type="text" placeholder="Ville (ex: Lyon, France)" />
        <button onclick="searchNearest()">Rechercher le prestataire le plus proche</button>
      </div>
    </section>

    <!-- Carte -->
    <section>
      <div id="map"></div>
    </section>

    <!-- Liste des prestataires -->
    <section style="padding:8px 12px;">
      <h3>Prestataires</h3>
      <div id="providerList"></div>
    </section>
  </main>

  <!-- Formulaire Prestataire -->
  <section id="providerFormSection" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Prestataire</h3>
      <form id="providerForm">
        <div class="row">
          <input id="companyName" placeholder="Raison sociale" required />
          <input id="contactName" placeholder="Nom" />
          <input id="firstName" placeholder="Prénom" />
        </div>
        <input id="address" placeholder="Adresse complète" required />
        <div class="row">
          <input id="email" type="email" placeholder="Email" />
          <input id="phone" placeholder="Téléphone" />
        </div>
        <div class="row">
          <input id="rate" placeholder="Tarif heure HT" />
          <input id="travelFees" placeholder="Frais déplacement HT" />
          <input id="totalCost" placeholder="Tarif total HT (auto si vide)" />
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button type="button" onclick="hideForm()">Annuler</button>
          <button type="submit">Enregistrer</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Modal Import -->
  <section id="importModal" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Importer des prestataires</h3>
      <p>Formats acceptés : <strong>.json</strong> ou <strong>.csv</strong> (en-têtes FR/EN reconnus).</p>
      <input id="importFile" type="file" accept=".json,.csv" />
      <label style="display:block; margin:8px 0;">
        <input id="skipDuplicates" type="checkbox" checked />
        Ignorer les doublons (email+phone)
      </label>
      <div class="row" style="justify-content:flex-end;">
        <button onclick="closeImportModal()">Fermer</button>
        <button onclick="handleImport()">Importer</button>
      </div>
    </div>
  </section>

  <!-- Modal Rapport d’intervention -->
  <section id="reportModal" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Rapport d’intervention</h3>
      <form id="reportForm">
        <div class="row">
          <input name="ticket" placeholder="N° Ticket" />
          <input name="interventionDate" type="date" />
        </div>
        <input name="siteAddress" placeholder="Adresse du site" />
        <div class="row">
          <input name="technician" list="technicianList" placeholder="Technicien" />
          <datalist id="technicianList"></datalist>
        </div>
        <textarea name="todo" rows="3" placeholder="Travail à faire"></textarea>
        <textarea name="done" rows="4" placeholder="Travail effectué"></textarea>
        <div class="row">
          <input name="start" type="time" placeholder="Heure d'arrivée" />
          <input name="end" type="time" placeholder="Heure de départ" />
        </div>
        <div class="row">
          <input name="signTech" placeholder="Signature technicien (nom)" />
          <input name="signClient" placeholder="Signature client (nom)" />
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button type="button" onclick="closeReportForm()">Fermer</button>
          <button type="button" onclick="printReport()">Imprimer</button>
          <button type="button" onclick="generatePDF()">Exporter en PDF</button>
        </div>
      </form>

      <!-- Aperçu utilisé par le PDF/print -->
      <div id="reportContent" style="display:none; margin-top:12px;"></div>
    </div>
  </section>

  <!-- Modal Itinéraire -->
  <section id="itineraryModal" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Calcul d’itinéraire</h3>
      <form id="itineraryForm" onsubmit="return false;">
        <input id="startAddress" placeholder="Départ" />
        <div id="extraDestinations"></div>
        <button type="button" onclick="addDestinationField()">+ Ajouter une étape</button>
        <input id="endAddress" placeholder="Arrivée" />
        <div class="row" style="justify-content:flex-end;">
          <button type="button" onclick="closeItineraryModal()">Fermer</button>
          <button type="button" onclick="calculateRoute()">Calculer</button>
          <button id="exportPdfBtn" type="button" onclick="exportItineraryToPDF()" style="display:none;">Exporter PDF</button>
        </div>
      </form>
      <div id="routeResult" style="margin-top:8px;"></div>
    </div>
  </section>

  <!-- Librairies JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- PDF & rendu de carte (pour itinéraire PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-image/0.0.4/leaflet-image.js" defer></script>

  <!-- Firebase (Compat v9 pour API globale firebase.*) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // ⚠️ REMPLACER PAR TA CONFIG EXACTE (celle déjà fonctionnelle dans ton projet)
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME.firebaseapp.com",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME.appspot.com",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME"
    };

    // Init Firebase + Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Exposé pour script.js
    window.db = db;

    // Auth anonyme (utilisée par script.js via window.authReady)
    window.authReady = (async () => {
      try {
        // Pas de persistance sur GitHub Pages (optional mais évite side-effects)
        if (auth.setPersistence) {
          await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
        }
      } catch (e) {
        console.warn("[Auth] setPersistence warning:", e?.message || e);
      }
      try {
        await auth.signInAnonymously();
        console.log("[Auth] Connecté anonymement");
      } catch (e) {
        console.warn("[Auth] Echec connexion anonyme:", e);
      }
    })();
  </script>

  <!-- Ton code applicatif -->
  <script src="script.js" defer></script>
</body>
</html>
