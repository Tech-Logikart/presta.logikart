<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOGIKART - Carte des Prestataires</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="logikart-logo.png" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- (Optionnel) MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <!-- Styles correctifs -->
  <style>
    /* En-tÃªte */
    header {
      position: sticky; top: 0; z-index: 3000;
      background: #004080; color: #fff;
      padding: 20px 12px 12px;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      text-align: center;
    }
    header h1 { margin: 0; font-size: 20px; font-weight: 600; }

    /* Burger TOUJOURS au-dessus */
    #burgerMenu{
      position: fixed !important; top:12px !important; right:12px !important;
      user-select:none; cursor:pointer; font-size:20px;
      background:#fff; color:#000; border:1px solid #eee; border-radius:8px;
      padding:6px 10px; line-height:1; z-index: 2147483647 !important;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
    }
    #menuDropdown{
      position: fixed !important; top:56px !important; right:12px !important;
      display:none; z-index: 2147483646 !important;
      background:#fff; border:1px solid #eee; border-radius:8px;
      padding:6px 0; min-width:240px; box-shadow:0 6px 20px rgba(0,0,0,.12);
    }
    #menuDropdown ul{ list-style:none; margin:0; padding:0; }
    #menuDropdown li{ padding:10px 14px; cursor:pointer; }
    #menuDropdown li:hover{ background:#f6f6f6; }
    #menuDropdown li.divider{ border-top:1px solid #eee; margin:6px 0 0 0; padding:0; }

    /* Carte & page */
    body, html { height:100%; }
    #map { width:100%; height:80vh; }

    /* Panneau Prestataires : panneau latÃ©ral fixe (au lieu du bas de page) */
    #providerList {
      display:none;
      position: fixed; top: 120px; right: 12px; z-index: 3500;
      width: min(380px, 92vw); max-height: 60vh; overflow:auto;
      background:#fff; border:1px solid #ddd; border-radius:10px; padding:12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
    }

    /* Modals gÃ©nÃ©riques */
    .modal, .modal-overlay {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);
      align-items:center; justify-content:center; z-index:2000;
    }
    .modal-content{
      background:#fff; padding:16px; border-radius:12px;
      max-width:720px; width:min(92vw,720px); max-height:85vh; overflow:auto;
    }
    .form-buttons{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Mise en page ItinÃ©raire : boutons sur la mÃªme ligne */
    #itineraryForm .controls-row {
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
      margin-top: 10px;
    }
    #itineraryForm .controls-row > button { flex: 0 0 auto; }
    #itineraryForm .full { width:100%; }
  </style>
</head>

<body>
  <!-- En-tÃªte -->
  <header>
    <img src="logikart-logo.png" alt="LOGIKART" style="height:60px;" />
    <h1>LOGIKART - Carte des Prestataires</h1>
  </header>

  <!-- Burger -->
  <div
    id="burgerMenu"
    role="button"
    tabindex="0"
    aria-haspopup="true"
    aria-expanded="false"
    aria-controls="menuDropdown"
    onclick="window.__toggleMenu && window.__toggleMenu(event)"
  >â˜°</div>

  <div id="menuDropdown" aria-label="Menu">
    <ul>
      <li onclick="toggleProviderList()">ğŸ“‹ Prestataires</li>
      <li onclick="openItineraryTool()">ğŸ§­ Calculer un itinÃ©raire</li>
      <li onclick="openReportForm()">ğŸ“ Imprimer rapport dâ€™intervention</li>
      <li class="divider"></li>
      <li onclick="exportProviders('json')">â¬‡ï¸ Exporter (JSON)</li>
      <li onclick="exportProviders('csv')">â¬‡ï¸ Exporter (CSV)</li>
      <li onclick="openImportModal()">â¬†ï¸ Importer</li>
    </ul>
  </div>

  <!-- Script DU BURGER (autonome) -->
  <script>
    (function () {
      const burger = document.getElementById('burgerMenu');
      const dropdown = document.getElementById('menuDropdown');
      function closeMenu(){ dropdown.style.display='none'; burger.setAttribute('aria-expanded','false'); }
      function toggleMenu(e){ if(e) e.stopPropagation(); const open=dropdown.style.display==='block'; dropdown.style.display=open?'none':'block'; burger.setAttribute('aria-expanded', String(!open)); }
      window.__toggleMenu = toggleMenu;
      burger.addEventListener('click', toggleMenu);
      burger.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleMenu(e);} });
      dropdown.addEventListener('click', (e)=> e.stopPropagation());
      document.addEventListener('click', (e)=>{ if(!dropdown.contains(e.target) && e.target!==burger) closeMenu(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
    })();
  </script>

  <!-- Barre dâ€™action -->
  <section style="padding:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
    <input type="text" id="cityInput" placeholder="Ville" style="width:260px; padding:8px; border:1px solid #ccc; border-radius:6px;" />
    <button onclick="searchNearest()">Rechercher</button>
    <button onclick="addProvider()">Ajouter un prestataire</button>
  </section>

  <!-- Carte -->
  <div id="map"></div>

  <!-- Panneau Prestataires -->
  <aside id="providerList"></aside>

  <!-- ===== Modal Prestataire ===== -->
  <div id="providerFormSection" class="modal-overlay">
    <div class="modal-content">
      <form id="providerForm">
        <h2>Ajouter un prestataire</h2>
        <input type="text" id="companyName" placeholder="RAISON SOCIALE" required />
        <input type="text" id="contactName" placeholder="NOM" required />
        <input type="text" id="firstName" placeholder="PRÃ‰NOM" />
        <input type="text" id="address" placeholder="ADRESSE POSTALE" required />
        <input type="email" id="email" placeholder="ADRESSE EMAIL" />
        <input type="tel" id="phone" placeholder="NÂ° DE TÃ‰LÃ‰PHONE" />
        <input type="number" id="rate" placeholder="Tarif heure HT (â‚¬)" step="0.01" />
        <input type="number" id="travelFees" placeholder="Frais de dÃ©placement HT (â‚¬)" step="0.01" />
        <input type="text" id="totalCost" placeholder="Tarif total HT (â‚¬)" readonly />
        <div class="form-buttons">
          <button type="submit">Enregistrer</button>
          <button type="button" onclick="hideForm()">Annuler</button>
        </div>
      </form>
      <script>
        // Calcul auto du total HT
        const rateInput = document.getElementById("rate");
        const travelInput = document.getElementById("travelFees");
        const totalInput = document.getElementById("totalCost");
        function updateTotal(){ const r=parseFloat(rateInput.value)||0, t=parseFloat(travelInput.value)||0; totalInput.value=(r+t).toFixed(2)+' â‚¬'; }
        rateInput.addEventListener("input", updateTotal);
        travelInput.addEventListener("input", updateTotal);
      </script>
    </div>
  </div>

  <!-- ===== Modal Rapport dâ€™intervention (UN SEUL) ===== -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeReportForm()">Ã—</span>
      <form id="reportForm">
        <img src="logikart-logo.png" alt="LOGIKART" class="logo" style="height:60px;" />
        <h2>Rapport dâ€™intervention LOGIKART</h2>
        <label>NumÃ©ro de ticket :</label>
        <input type="text" name="ticket" required />
        <label>Date dâ€™intervention :</label>
        <input type="date" name="interventionDate" required />
        <label>Adresse du site :</label>
        <input type="text" name="siteAddress" required />
        <label>Nom du technicien :</label>
        <input type="text" name="technician" list="technicianList" required />
        <datalist id="technicianList"></datalist>
        <label>Travail Ã  faire :</label>
        <textarea name="todo" rows="6" required></textarea>
        <label>Travail effectuÃ© :</label>
        <textarea name="done" rows="10" required></textarea>
        <label>Heure dâ€™arrivÃ©e :</label>
        <input type="time" name="start" required />
        <label>Heure de dÃ©part :</label>
        <input type="time" name="end" required />
        <label>Signature du technicien :</label>
        <input type="text" name="signTech" />
        <label>Signature du client :</label>
        <input type="text" name="signClient" />
        <div class="form-buttons">
          <button type="button" onclick="printReport()">ğŸ–¨ï¸ Imprimer</button>
          <button type="button" onclick="generatePDF()">ğŸ“„ GÃ©nÃ©rer PDF</button>
          <button type="button" onclick="closeReportForm()">âŒ Fermer</button>
        </div>
      </form>
      <!-- Zone dâ€™aperÃ§u (utilisÃ©e par le PDF/print) -->
      <div id="reportContent" style="display:none;"></div>
    </div>
  </div>

  <!-- ===== Modal ItinÃ©raire (boutons cÃ´te Ã  cÃ´te) ===== -->
  <div id="itineraryModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeItineraryModal()">Ã—</span>
      <h2>ğŸ§­ Calcul d'itinÃ©raire</h2>
      <form id="itineraryForm" onsubmit="return false;">
        <label class="full">Adresse de dÃ©part :</label>
        <input class="full" type="text" id="startAddress" required />

        <div id="extraDestinations" class="full"></div>

        <label class="full">Adresse de destination :</label>
        <input class="full" type="text" id="endAddress" required />

        <div class="controls-row">
          <button id="addStepBtn" type="button" onclick="addDestinationField()">â• Ajouter une Ã©tape</button>
          <button type="button" onclick="calculateRoute()">ğŸš— Calculer lâ€™itinÃ©raire</button>
          <button id="exportPdfBtn" type="button" onclick="exportItineraryToPDF()" style="display:none;">ğŸ“„ Exporter en PDF</button>
        </div>
      </form>
      <div id="routeResult" style="margin-top:15px;"></div>
    </div>
  </div>

  <!-- ===== Modal Import ===== -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeImportModal()">Ã—</span>
      <h2>â†•ï¸ Importer des prestataires</h2>
      <p>Fichiers acceptÃ©s : <strong>JSON</strong> ou <strong>CSV</strong> (entÃªtes FR/EN reconnus).</p>
      <input type="file" id="importFile" accept=".json,.csv" />
      <label style="display:block; margin-top:8px;">
        <input type="checkbox" id="skipDuplicates" checked />
        Ignorer les doublons (mÃªme email + tÃ©lÃ©phone)
      </label>
      <div class="form-buttons" style="margin-top:12px;">
        <button type="button" onclick="handleImport()">Importer</button>
        <button type="button" onclick="closeImportModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- (Optionnel) MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- Initialisation Firebase + Auth anonyme -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA59iB-7skqRFngoF24VkAHZMBSIonh7Ho",
      authDomain: "lgk-presta.firebaseapp.com",
      projectId: "lgk-presta",
      storageBucket: "lgk-presta.firebasestorage.app",
      messagingSenderId: "386610630784",
      appId: "1:386610630784:web:015bb6c04156918d369665"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    window.db = db;

    // Promise dâ€™auth anonyme utilisÃ©e par script.js
    window.authReady = (async () => {
      try {
        if (auth.setPersistence) {
          await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
        }
      } catch (e) {
        console.warn("[Auth] setPersistence:", e?.message || e);
      }
      try {
        await auth.signInAnonymously();
        console.log("[Auth] ConnectÃ© anonymement");
      } catch (e) {
        console.warn("[Auth] Echec connexion anonyme:", e);
      }
    })();
  </script>

  <!-- PDF & rendu de carte -->
  <!-- âš ï¸ Garder UNIQUEMENT html2pdf.bundle (nâ€™ajoute pas html2canvas sÃ©parÃ©, sinon PDF blanc) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

  <!-- Script principal -->
  <script src="script.js"></script>
</body>
</html>
