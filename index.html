<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOGIKART - Carte des Prestataires</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="logikart-logo.png" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>
  <header style="display:flex; flex-direction:column; align-items:center; gap:10px; padding:16px;">
    <img src="logikart-logo.png" alt="LOGIKART" style="height:60px;" />
    <h1 style="text-align:center; margin:0;">LOGIKART - Réseau de prestataires informatiques</h1>

    <!-- Menu burger -->
    <div id="burgerMenu" style="position:relative; user-select:none; cursor:pointer; font-size:20px;">
      ☰
      <div id="menuDropdown"
           style="display:none; position:absolute; top: 1.8rem; right:0; background:#fff; border:1px solid #eee; border-radius:8px; padding:6px 0; z-index:1000; min-width:240px; box-shadow:0 6px 20px rgba(0,0,0,.08);">
        <ul style="list-style:none; margin:0; padding:0;">
          <li style="padding:10px 14px; cursor:pointer;" onclick="toggleProviderList()">📋 Prestataires</li>
          <li style="padding:10px 14px; cursor:pointer;" onclick="openItineraryTool()">🧭 Calculer un itinéraire</li>
          <li style="padding:10px 14px; cursor:pointer;" onclick="openReportForm()">📝 Imprimer rapport d’intervention</li>
          <li style="border-top:1px solid #eee; margin:6px 0 0 0;"></li>
          <li style="padding:10px 14px; cursor:pointer;" onclick="exportProviders('json')">⬇️ Exporter (JSON)</li>
          <li style="padding:10px 14px; cursor:pointer;" onclick="exportProviders('csv')">⬇️ Exporter (CSV)</li>
          <li style="padding:10px 14px; cursor:pointer;" onclick="openImportModal()">⬆️ Importer</li>
        </ul>
      </div>
    </div>
  </header>

  <section style="padding: 10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
    <input type="text" id="cityInput" placeholder="Ville" style="width: 260px; padding:8px; border:1px solid #ccc; border-radius:6px;" />
    <button onclick="searchNearest()">Rechercher</button>
    <button onclick="addProvider()">Ajouter un prestataire</button>
  </section>

  <div id="map" style="width:100%; height:80vh;"></div>

  <!-- Formulaire modal d'ajout / édition -->
  <div id="providerFormSection" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <form id="providerForm">
        <h2>Ajouter un prestataire</h2>
        <input type="text" id="companyName" placeholder="RAISON SOCIALE" required />
        <input type="text" id="contactName" placeholder="NOM" required />
        <input type="text" id="firstName" placeholder="PRÉNOM" />
        <input type="text" id="address" placeholder="ADRESSE POSTALE" required />
        <input type="email" id="email" placeholder="ADRESSE EMAIL" />
        <input type="tel" id="phone" placeholder="N° DE TÉLÉPHONE" />
        <input type="number" id="rate" placeholder="Tarif heure HT (€)" step="0.01" />
        <input type="number" id="travelFees" placeholder="Frais de déplacement HT (€)" step="0.01" />
        <input type="text" id="totalCost" placeholder="Tarif total HT (€)" readonly />
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="submit">Enregistrer</button>
          <button type="button" onclick="hideForm()">Annuler</button>
        </div>
      </form>
      <script>
        const rateInput = document.getElementById("rate");
        const travelInput = document.getElementById("travelFees");
        const totalInput = document.getElementById("totalCost");
        function updateTotal() {
          const rate = parseFloat(rateInput.value) || 0;
          const travel = parseFloat(travelInput.value) || 0;
          totalInput.value = (rate + travel).toFixed(2) + " €";
        }
        rateInput.addEventListener("input", updateTotal);
        travelInput.addEventListener("input", updateTotal);
      </script>
    </div>
  </div>

  <!-- Liste des prestataires -->
  <aside id="providerList" style="display:none;"></aside>

  <!-- Rapport d’intervention -->
  <div id="reportModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeReportForm()">×</span>
      <form id="reportForm">
        <img src="logikart-logo.png" alt="LOGIKART" class="logo" style="height:60px;" />
        <h2>Rapport d’intervention LOGIKART</h2>
        <label>Numéro de ticket :</label>
        <input type="text" name="ticket" required />
        <label>Date d’intervention :</label>
        <input type="date" name="interventionDate" required />
        <label>Adresse du site :</label>
        <input type="text" name="siteAddress" required />
        <label>Nom du technicien :</label>
        <input type="text" name="technician" list="technicianList" required />
        <datalist id="technicianList"></datalist>
        <label>Travail à faire :</label>
        <textarea name="todo" rows="6" required></textarea>
        <label>Travail effectué :</label>
        <textarea name="done" rows="10" required></textarea>
        <label>Heure d’arrivée :</label>
        <input type="time" name="start" required />
        <label>Heure de départ :</label>
        <input type="time" name="end" required />
        <label>Signature du technicien :</label>
        <input type="text" name="signTech" />
        <label>Signature du client :</label>
        <input type="text" name="signClient" />
        <div class="form-buttons">
          <button type="button" onclick="generatePDF()">📄 Générer PDF</button>
          <button type="button" onclick="closeReportForm()">❌ Fermer</button>
        </div>
      </form>
      <div id="reportContent" style="display:none;"></div>
    </div>
  </div>

  <!-- Itinéraire -->
  <div id="itineraryModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeItineraryModal()">×</span>
      <h2>🧭 Calcul d'itinéraire</h2>
      <form id="itineraryForm">
        <label>Adresse de départ :</label>
        <input type="text" id="startAddress" required />
        <label>Adresse de destination :</label>
        <input type="text" id="endAddress" required />
        <div id="extraDestinations"></div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" onclick="addDestinationField()">➕ Ajouter une destination</button>
          <button type="button" onclick="calculateRoute()">🚗 Calculer l’itinéraire</button>
        </div>
      </form>
      <div id="routeResult" style="margin-top:15px;"></div>
      <button type="button" onclick="exportItineraryToPDF()" style="margin-top:10px; display:none;" id="exportPdfBtn">📄 Exporter en PDF</button>
    </div>
  </div>

  <!-- Import prestataires -->
  <div id="importModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeImportModal()">×</span>
      <h2>↕️ Importer des prestataires</h2>
      <p>Fichiers acceptés : <strong>JSON</strong> ou <strong>CSV</strong> (entêtes : <code>id,companyName,contactName,firstName,address,email,phone,rate,travelFees,totalCost</code>)</p>
      <input type="file" id="importFile" accept=".json,.csv" />
      <label style="display:block; margin-top:8px;">
        <input type="checkbox" id="skipDuplicates" checked />
        Ignorer les doublons (même email + téléphone)
      </label>
      <div class="form-buttons" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button type="button" onclick="handleImport()">Importer</button>
        <button type="button" onclick="closeImportModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Initialisation Firebase + Auth anonyme -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA59iB-7skqRFngoF24VkAHZMBSIonh7Ho",
      authDomain: "lgk-presta.firebaseapp.com",
      projectId: "lgk-presta",
      storageBucket: "lgk-presta.firebasestorage.app",
      messagingSenderId: "386610630784",
      appId: "1:386610630784:web:015bb6c04156918d369665"
    };
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();

    // Auth anonyme – résolue quand prête (⚠️ activer "Anonymous" dans la console)
    window.authReady = new Promise((resolve) => {
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          console.log('[Auth] Anonyme connecté:', user.uid);
          resolve(user);
        } else {
          firebase.auth().signInAnonymously()
            .then((cred) => { console.log('[Auth] Connexion anonyme ok:', cred.user?.uid); resolve(cred.user); })
            .catch((err) => { console.error('[Auth] Echec connexion anonyme:', err); resolve(null); });
        }
      });
    });
  </script>

  <!-- PDF & rendu carte -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Script principal -->
  <script src="script.js"></script>
</body>
</html>
