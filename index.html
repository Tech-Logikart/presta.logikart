# Write corrected files based on user's uploads, adding Firebase Auth (compat) and delaying Firestore listeners until after auth.
from pathlib import Path

index_content = """<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOGIKART - Carte des Prestataires</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>
  <header style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
    <img src="logikart-logo.png" alt="LOGIKART" style="height: 60px; margin-bottom: 10px;" />
    <h1 style="text-align: center;">LOGIKART - R√©seau de prestataires informatiques</h1>

    <!-- Menu burger -->
    <div id="burgerMenu">
      ‚ò∞
      <div id="menuDropdown" class="hidden">
        <ul>
          <li onclick="toggleProviderList()">üìã Prestataires</li>
          <li onclick="openItineraryTool()">üß≠ Calculer un itin√©raire</li>
          <li onclick="openReportForm()">üìù Imprimer rapport d‚Äôintervention</li>
          <li style="border-top:1px solid #eee; margin:6px 0 0 0;"></li>
        <li onclick="exportProviders('json')">‚¨áÔ∏è Exporter (JSON)</li>
          <li onclick="exportProviders('csv')">‚¨áÔ∏è Exporter (CSV)</li>
          <li onclick="openImportModal()">‚¨ÜÔ∏è Importer</li>
        </ul>
      </div>
    </div>
  </header>

  <section style="padding: 10px; display: flex; gap: 10px; justify-content: center;">
    <input type="text" id="cityInput" placeholder="Ville" style="width: 250px; padding: 8px;" />
    <button onclick="searchNearest()">Rechercher</button>
    <button onclick="addProvider()">Ajouter un prestataire</button>
  </section>

  <div id="map" style="width: 100%; height: 80vh;"></div>

  <!-- Formulaire modal d'ajout / √©dition de prestataire -->
  <div id="providerFormSection" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <form id="providerForm">
        <h2>Ajouter un prestataire</h2>
        <input type="text" id="companyName" placeholder="RAISON SOCIALE" required />
        <input type="text" id="contactName" placeholder="NOM" required />
        <input type="text" id="firstName" placeholder="PR√âNOM" required />
        <input type="text" id="address" placeholder="ADRESSE POSTALE" required />
        <input type="email" id="email" placeholder="ADRESSE EMAIL" required />
        <input type="tel" id="phone" placeholder="N¬∞ DE T√âL√âPHONE" required />
        <input type="number" id="rate" placeholder="Tarif heure HT (‚Ç¨)" step="0.01" required />
        <input type="number" id="travelFees" placeholder="Frais de d√©placement HT (‚Ç¨)" step="0.01" required />
        <input type="text" id="totalCost" placeholder="Tarif total HT (‚Ç¨)" readonly />
        <button type="submit">Enregistrer</button>
        <button type="button" onclick="hideForm()">Annuler</button>
      </form>
      <script>
        const rateInput = document.getElementById("rate");
        const travelInput = document.getElementById("travelFees");
        const totalInput = document.getElementById("totalCost");
        function updateTotal() {
          const rate = parseFloat(rateInput.value) || 0;
          const travel = parseFloat(travelInput.value) || 0;
          totalInput.value = (rate + travel).toFixed(2) + " ‚Ç¨";
        }
        rateInput.addEventListener("input", updateTotal);
        travelInput.addEventListener("input", updateTotal);
      </script>
    </div>
  </div>

  <!-- Liste des prestataires -->
  <aside id="providerList" style="display: none;"></aside>

  <!-- Rapport d‚Äôintervention -->
  <div id="reportModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeReportForm()">√ó</span>
      <form id="reportForm">
        <img src="logikart-logo.png" alt="LOGIKART" class="logo" style="height: 60px;" />
        <h2>Rapport d‚Äôintervention LOGIKART</h2>
        <label for="ticket">Num√©ro de ticket :</label>
        <input type="text" name="ticket" required />
        <label for="interventionDate">Date d‚Äôintervention :</label>
        <input type="date" name="interventionDate" required />
        <label for="siteAddress">Adresse du site :</label>
        <input type="text" name="siteAddress" required />
        <label for="technician">Nom du technicien :</label>
        <input type="text" name="technician" list="technicianList" required />
        <datalist id="technicianList"></datalist>
        <label for="todo">Travail √† faire :</label>
        <textarea name="todo" rows="6" required></textarea>
        <label for="done">Travail effectu√© :</label>
        <textarea name="done" rows="10" required></textarea>
        <label for="start">Heure d‚Äôarriv√©e :</label>
        <input type="time" name="start" required />
        <label for="end">Heure de d√©part :</label>
        <input type="time" name="end" required />
        <label for="signTech">Signature du technicien :</label>
        <input type="text" name="signTech" />
        <label for="signClient">Signature du client :</label>
        <input type="text" name="signClient" />
        <div class="form-buttons">
          <button type="button" onclick="generatePDF()">üìÑ G√©n√©rer PDF</button>
          <button type="button" onclick="closeReportForm()">‚ùå Fermer</button>
        </div>
      </form>
      <div id="reportContent" style="display: none;"></div>
    </div>
  </div>

  <!-- Itin√©raire -->
  <div id="itineraryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeItineraryModal()">√ó</span>
      <h2>üß≠ Calcul d'itin√©raire</h2>
      <form id="itineraryForm">
        <label>Adresse de d√©part :</label>
        <input type="text" id="startAddress" required />
        <label>Adresse de destination :</label>
        <input type="text" id="endAddress" required />
        <div id="extraDestinations"></div>
        <button type="button" onclick="addDestinationField()">‚ûï Ajouter une destination</button>
        <button type="button" onclick="calculateRoute()">üöó Calculer l‚Äôitin√©raire</button>
      </form>
      <div id="routeResult" style="margin-top: 15px;"></div>
      <button type="button" onclick="exportItineraryToPDF()" style="margin-top: 10px; display: none;" id="exportPdfBtn">üìÑ Exporter en PDF</button>
    </div>
  </div>

  <!-- Import prestataires -->
  <div id="importModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeImportModal()">√ó</span>
      <h2>‚ÜïÔ∏è Importer des prestataires</h2>
      <p>Fichiers accept√©s : <strong>JSON</strong> (tableau d‚Äôobjets) ou <strong>CSV</strong> avec en-t√™tes :
        <code>id,companyName,contactName,firstName,address,email,phone,rate,travelFees,totalCost</code>
      </p>
      <input type="file" id="importFile" accept=".json,.csv" />
      <label style="display:block; margin-top:8px;">
        <input type="checkbox" id="skipDuplicates" checked />
        Ignorer les doublons (m√™me email + t√©l√©phone)
      </label>
      <div class="form-buttons" style="margin-top:12px;">
        <button type="button" onclick="handleImport()">Importer</button>
        <button type="button" onclick="closeImportModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA59iB-7skqRFngoF24VkAHZMBSIonh7Ho",
      authDomain: "lgk-presta.firebaseapp.com",
      projectId: "lgk-presta",
      storageBucket: "lgk-presta.firebasestorage.app",
      messagingSenderId: "386610630784",
      appId: "1:386610630784:web:015bb6c04156918d369665"
    };
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
    window.auth = firebase.auth();
  </script>

  <!-- Librairies PDF & Carte -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Script principal -->
  <script src="script.fixed.js"></script>
</body>
</html>
"""

script_content = """// --- LOGIKART / script.fixed.js ---
// Initialisation de la carte
const map = L.map('map').setView([48.8566, 2.3522], 5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let editingIndex = null;
let realtimeStarted = false;

// -- Formulaire prestataire
function addProvider() {
  const modal = document.getElementById("providerFormSection");
  if (!modal) return console.error("#providerFormSection introuvable");
  modal.style.display = "flex";
}

function hideForm() {
  const form = document.getElementById("providerForm");
  const modal = document.getElementById("providerFormSection");
  if (form) form.reset();
  if (modal) modal.style.display = "none";
  editingIndex = null;
}

document.getElementById("providerForm")?.addEventListener("submit", handleFormSubmit);

async function handleFormSubmit(event) {
  event.preventDefault();

  const provider = {
    companyName: document.getElementById("companyName").value,
    contactName: document.getElementById("contactName").value,
    firstName: document.getElementById("firstName").value,
    address: document.getElementById("address").value,
    email: document.getElementById("email").value,
    phone: document.getElementById("phone").value,
    rate: document.getElementById("rate").value,
    travelFees: document.getElementById("travelFees").value,
    totalCost: document.getElementById("totalCost").value
  };

  let providers = JSON.parse(localStorage.getItem("providers")) || [];

  try {
    if (editingIndex !== null) {
      const existing = providers[editingIndex];
      const updated = { ...existing, ...provider };
      providers[editingIndex] = updated;

      if (existing?.id) {
        await db.collection("prestataires").doc(existing.id).update(provider);
      } else {
        const docRef = await db.collection("prestataires").add(provider);
        updated.id = docRef.id;
      }
    } else {
      const docRef = await db.collection("prestataires").add(provider);
      provider.id = docRef.id;
      providers.push(provider);
    }

    localStorage.setItem("providers", JSON.stringify(providers));

    // Ajoute le marqueur imm√©diatement + met √† jour la liste
    geocodeAndAddToMap(provider, { pan: true, open: true });
    updateProviderList();
    const list = document.getElementById("providerList");
    if (list) list.style.display = "block";
    hideForm();
  } catch (e) {
    console.error("Erreur Firestore :", e);
    alert("Impossible d‚Äôenregistrer sur le serveur. V√©rifie l‚Äôauthentification et les r√®gles Firestore.");
  }
}

// --- UTILITAIRES de g√©ocodage ---
async function fetchNominatim(query) {
  const proxyUrl = `https://proxy-logikart.samir-mouheb.workers.dev/?url=${encodeURIComponent('https://nominatim.openstreetmap.org/search?format=json&q=' + query)}`;
  const directUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;

  try {
    const r = await fetch(proxyUrl);
    if (r.ok) {
      const data = await r.json();
      if (Array.isArray(data) && data.length) return data;
    }
  } catch (_) {}

  try {
    const r2 = await fetch(directUrl, {
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'LOGIKART/1.0 (contact@logikart.app)'
      }
    });
    if (r2.ok) {
      const data2 = await r2.json();
      if (Array.isArray(data2) && data2.length) return data2;
    }
  } catch (_) {}

  return [];
}

function buildQueries(addr) {
  const base = (addr || "").trim();
  const withCountry = /france/i.test(base) ? base : `${base}, France`;
  const simple = withCountry.replace(/[;]/g, ' ').replace(/\\s{2,}/g, ' ').trim();
  const moved = simple.replace(/(\\d{5})\\s+([A-Za-z√Ä-√ø\\-']+)/, '$2 $1');
  return [base, withCountry, simple, moved].filter((v, i, a) => v && a.indexOf(v) === i);
}

async function geocodeAndAddToMap(provider, opts = { pan: false, open: false }) {
  if (!provider?.address) return;

  const queries = buildQueries(provider.address);
  let result = null;

  for (const q of queries) {
    const data = await fetchNominatim(q);
    if (data && data.length) { result = data[0]; break; }
  }

  if (!result) {
    console.warn("G√©ocodage introuvable pour:", provider.address);
    return;
  }

  const lat = parseFloat(result.lat);
  const lon = parseFloat(result.lon);

  const marker = L.marker([lat, lon])
    .addTo(map)
    .bindPopup(
      `<strong>${provider.companyName || ''}</strong><br>${provider.contactName || ''}<br>${provider.email || ''}<br>${provider.phone || ''}`
    );

  markers.push(marker);

  if (opts.pan) {
    map.setView([lat, lon], Math.max(map.getZoom(), 14));
  }
  if (opts.open) {
    marker.openPopup();
  }
}

function clearMarkers() {
  markers.forEach(marker => map.removeLayer(marker));
  markers = [];
}

async function searchNearest() {
  const city = document.getElementById("cityInput").value.trim();
  if (!city) return;

  const cityData = await fetchNominatim(/france/i.test(city) ? city : `${city}, France`);
  if (!cityData.length) {
    alert("Ville non trouv√©e.");
    return;
  }

  const userLat = parseFloat(cityData[0].lat);
  const userLon = parseFloat(cityData[0].lon);

  const providers = JSON.parse(localStorage.getItem("providers")) || [];

  let nearest = null;
  let minDistance = Infinity;

  for (const provider of providers) {
    const data = await fetchNominatim(provider.address || "");
    if (!data.length) continue;
    const lat = parseFloat(data[0].lat);
    const lon = parseFloat(data[0].lon);
    const distance = Math.sqrt(Math.pow(lat - userLat, 2) + Math.pow(lon - userLon, 2));

    if (distance < minDistance) {
      minDistance = distance;
      nearest = { ...provider, lat, lon };
    }
  }
  
  if (nearest) {
    map.setView([nearest.lat, nearest.lon], 12);
    L.popup()
      .setLatLng([nearest.lat, nearest.lon])
      .setContent(`<strong>${nearest.companyName}</strong><br>${nearest.contactName}<br>${nearest.email}<br>${nearest.phone}`)
      .openOn(map);
  } else {
    alert("Aucun prestataire trouv√©.");
  }
}

function loadProvidersFromLocalStorage() {
  clearMarkers();
  const providers = JSON.parse(localStorage.getItem("providers")) || [];
  providers.forEach(provider => {
    geocodeAndAddToMap(provider);
  });
  updateProviderList();
}

function updateProviderList() {
  const container = document.getElementById("providerList");
  if (!container) return;

  container.innerHTML = "";
  const providers = JSON.parse(localStorage.getItem("providers")) || [];

  providers.forEach((p, i) => {
    const div = document.createElement("div");
    div.className = "provider-entry";
    div.innerHTML = `
      <strong>${p.companyName}</strong><br>
      üë§ ${p.contactName} ${p.firstName ? `(${p.firstName})` : ""}<br>
      üìß ${p.email}<br>
      üìû ${p.phone}<br>
      üí∞ Tarif total HT : ${p.totalCost || "N/A"}<br>
      <button onclick="editProvider(${i})">‚úèÔ∏è Modifier</button>
      <button onclick="deleteProvider(${i})">üóëÔ∏è Supprimer</button>
      <hr>
    `;
    container.appendChild(div);
  });
}

function editProvider(index) {
  const providers = JSON.parse(localStorage.getItem("providers")) || [];
  const p = providers[index];

  document.getElementById("companyName").value = p.companyName || "";
  document.getElementById("contactName").value = p.contactName || "";
  document.getElementById("address").value = p.address || "";
  document.getElementById("email").value = p.email || "";
  document.getElementById("phone").value = p.phone || "";
  document.getElementById("firstName").value = p.firstName || "";
  document.getElementById("rate").value = p.rate || "";
  document.getElementById("travelFees").value = p.travelFees || "";
  document.getElementById("totalCost").value = p.totalCost || "";

  if (typeof updateTotal === "function") {
    updateTotal();
  }

  editingIndex = index;
  addProvider();
}

// --- Firestore temps r√©el (lanc√©e APRES auth) ---
function startRealtimeSync() {
  if (!window.db) return console.error("Firestore non initialis√©");
  if (realtimeStarted) return;
  realtimeStarted = true;

  db.collection("prestataires").onSnapshot((snap) => {
    const providers = [];
    snap.forEach(doc => providers.push({ id: doc.id, ...doc.data() }));
    localStorage.setItem("providers", JSON.stringify(providers));
    clearMarkers();
    providers.forEach(geocodeAndAddToMap);
    updateProviderList();
  }, (err) => {
    console.error("onSnapshot error:", err);
    if ((err?.code || '').includes('permission') || /insufficient/i.test(err?.message || '')) {
      alert("Acc√®s refus√© par Firestore (r√®gles). Assure-toi que la lecture est autoris√©e pour les utilisateurs authentifi√©s.");
    } else {
      alert("Erreur Firestore. D√©tails en console.");
    }
  });
}

// --- Force un rechargement complet depuis Firestore (apr√®s import) ---
async function refreshProvidersFromServer() {
  try {
    const snap = await db.collection("prestataires").get();
    const providers = [];
    snap.forEach(doc => providers.push({ id: doc.id, ...doc.data() }));
    localStorage.setItem("providers", JSON.stringify(providers));
    clearMarkers();
    providers.forEach(geocodeAndAddToMap);
    updateProviderList();
  } catch (e) {
    console.error("refreshProvidersFromServer error:", e);
  }
}

// --- EXPORT JSON / CSV ---
function exportProviders(format = "json") {
  const providers = JSON.parse(localStorage.getItem("providers")) || [];
  if (!providers.length) {
    alert("Aucun prestataire √† exporter.");
    return;
  }

  const headers = ["id","companyName","contactName","firstName","address","email","phone","rate","travelFees","totalCost"];

  if (format === "json") {
    const blob = new Blob([JSON.stringify(providers, null, 2)], { type: "application/json" });
    triggerDownload(blob, "prestataires.json");
    return;
  }

  if (format === "csv") {
    const escape = (v) => {
      if (v === null || v === undefined) return "";
      v = String(v);
      return /[",\\n\\r;]/.test(v) ? `"${v.replace(/"/g, '""')}"` : v;
    };

    const rows = [headers.join(",")];
    for (const p of providers) {
      const row = headers.map(h => escape(p[h] ?? ""));
      rows.push(row.join(","));
    }
    const csv = rows.join("\\r\\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    triggerDownload(blob, "prestataires.csv");
    return;
  }

  alert("Format non support√©.");
}

function triggerDownload(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

// --- IMPORT JSON / CSV ---
function openImportModal() {
  const modal = document.getElementById("importModal");
  if (modal) modal.style.display = "flex";
}
function closeImportModal() {
  const modal = document.getElementById("importModal");
  if (modal) modal.style.display = "none";
  const input = document.getElementById("importFile");
  if (input) input.value = "";
}

function normalizeProvider(obj) {
  const norm = (s) => (s ?? "").toString().trim();
  const num = (s) => {
    if (s === null || s === undefined || s === "") return "";
    const n = parseFloat(String(s).replace(",", "."));
    return isNaN(n) ? "" : n.toFixed(2);
  };

  const p = {
    companyName: norm(obj.companyName ?? obj.raisonSociale),
    contactName: norm(obj.contactName ?? obj.nom),
    firstName: norm(obj.firstName ?? obj.prenom),
    address: norm(obj.address ?? obj.adresse),
    email: norm(obj.email),
    phone: norm(obj.phone ?? obj.telephone),
    rate: norm(obj.rate ?? obj.tarifHeureHT),
    travelFees: norm(obj.travelFees ?? obj.fraisDeplacementHT),
    totalCost: norm(obj.totalCost ?? obj.tarifTotalHT),
  };

  if (!p.totalCost) {
    const r = parseFloat(num(p.rate)) || 0;
    const t = parseFloat(num(p.travelFees)) || 0;
    if (r + t > 0) p.totalCost = (r + t).toFixed(2) + " ‚Ç¨";
  }

  return p;
}

function detectDelimiter(headerLine) {
  const comma = (headerLine.match(/,/g) || []).length;
  const semi = (headerLine.match(/;/g) || []).length;
  return semi > comma ? ";" : ",";
}

function parseCSVToObjects(text) {
  const lines = text.replace(/\\r\\n/g, "\\n").replace(/\\r/g, "\\n").split("\\n").filter(l => l.length);
  if (!lines.length) return [];
  const delimiter = detectDelimiter(lines[0]);

  function parseLine(line) {
    const out = [];
    let cur = "";
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === delimiter && !inQuotes) {
        out.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  const headersRaw = parseLine(lines[0]).map(h => h.trim());

  const normalizeKey = (k) => k
    .toLowerCase()
    .normalize("NFD").replace(/\\p{Diacritic}/gu, "")
    .replace(/\\s+/g, "")
    .replace(/[^a-z0-9]/g, "");

  const headerMap = {};
  headersRaw.forEach((h, i) => {
    const n = normalizeKey(h);
    if (n.includes("raisonsociale") || n === "companyname") headerMap[i] = "companyName";
    else if (n === "nom" || n === "contactname") headerMap[i] = "contactName";
    else if (n === "prenom" || n === "firstname") headerMap[i] = "firstName";
    else if (n.includes("adresse") || n === "address") headerMap[i] = "address";
    else if (n.includes("email")) headerMap[i] = "email";
    else if (n.includes("telephone") || n === "phone") headerMap[i] = "phone";
    else if (n.includes("tarifheure") || n === "rate") headerMap[i] = "rate";
    else if (n.includes("fraisdeplacement") || n === "travelfees") headerMap[i] = "travelFees";
    else if (n.includes("tariftotal") || n === "totalcost") headerMap[i] = "totalCost";
    else if (n === "id") headerMap[i] = "id";
  });

  const rows = [];
  for (let li = 1; li < lines.length; li++) {
    const cols = parseLine(lines[li]);
    if (cols.length === 1 && cols[0].trim() === "") continue;
    const obj = {};
    cols.forEach((val, i) => {
      const key = headerMap[i];
      if (key) obj[key] = val.trim();
    });
    rows.push(obj);
  }
  return rows;
}

async function handleImport() {
  const input = document.getElementById("importFile");
  if (!input?.files?.length) {
    alert("Choisis un fichier √† importer.");
    return;
  }
  const file = input.files[0];
  const text = await file.text();

  let incoming = [];
  if (file.name.toLowerCase().endsWith(".json")) {
    try {
      const data = JSON.parse(text);
      if (Array.isArray(data)) incoming = data;
      else if (data && typeof data === "object") incoming = [data];
    } catch (e) {
      console.error(e);
      alert("JSON invalide.");
      return;
    }
  } else {
    incoming = parseCSVToObjects(text);
  }

  if (!incoming.length) {
    alert("Aucune donn√©e d√©tect√©e.");
    return;
  }

  const skipDuplicates = document.getElementById("skipDuplicates")?.checked ?? true;
  const existing = JSON.parse(localStorage.getItem("providers")) || [];
  const keyOf = (p) => (String(p.email || "").toLowerCase() + "|" + String(p.phone || ""));

  const byKey = new Map(existing.map(p => [keyOf(p), p]));
  const results = { added: 0, updated: 0, skipped: 0, errors: 0 };

  for (const raw of incoming) {
    const p = normalizeProvider(raw);

    if (!p.companyName && !p.contactName && !p.email) {
      results.skipped++;
      continue;
    }

    const existingMatch = byKey.get(keyOf(p));
    try {
      if (existingMatch && skipDuplicates) {
        results.skipped++;
      } else if (existingMatch?.id) {
        await db.collection("prestataires").doc(existingMatch.id).update(p);
        results.updated++;
      } else if (raw.id) {
        try {
          await db.collection("prestataires").doc(raw.id).set(p, { merge: true });
          results.added++;
        } catch {
          const docRef = await db.collection("prestataires").add(p);
          void docRef;
          results.added++;
        }
      } else {
        const docRef = await db.collection("prestataires").add(p);
        void docRef;
        results.added++;
      }
    } catch (e) {
      console.error("Import error:", e);
      results.errors++;
    }
  }

  await refreshProvidersFromServer();

  alert(`Import termin√© :
- ${results.added} ajout√©s
- ${results.updated} mis √† jour
- ${results.skipped} ignor√©s
- ${results.errors} erreurs`);

  closeImportModal();
}

// -------- AUTH: lancer la synchro APRES connexion ----------
function ensureAuthAndStart() {
  if (!window.auth) { console.error("Firebase Auth non dispo"); return; }
  auth.onAuthStateChanged((user) => {
    if (user) {
      startRealtimeSync();
    } else {
      auth.signInAnonymously().catch((err) => {
        console.error("Auth anonyme √©chou√©e:", err);
        alert("Impossible de s'authentifier aupr√®s de Firestore.");
      });
    }
  });
}

// --- Menu / init
document.addEventListener("DOMContentLoaded", () => {
  loadProvidersFromLocalStorage();
  // NE PLUS d√©marrer startRealtimeSync ici ; attendre l'auth :
  ensureAuthAndStart();

  const burger = document.getElementById("burgerMenu");
  const dropdown = document.getElementById("menuDropdown");

  burger?.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdown?.classList.toggle("hidden");
  });

  document.addEventListener("click", () => {
    dropdown?.classList.add("hidden");
  });
});

function toggleProviderList() {
  const list = document.getElementById("providerList");
  if (!list) return;
  list.style.display = list.style.display === "none" ? "block" : "none";
}

// --- Rapport d‚Äôintervention --- (inchang√© sauf fonctions utilitaires)
function openReportForm() {
  const modal = document.getElementById("reportModal");
  if (!modal) return;
  modal.style.display = "flex";

  const form = document.getElementById("reportForm");
  const get = id => form.querySelector(`[name="${id}"]`) || form.querySelector(`#${id}`);

  const values = {
    ticket: get("ticket")?.value || "",
    date: get("interventionDate")?.value || "",
    site: get("siteAddress")?.value || "",
    tech: get("technician")?.value || "",
    todo: get("todo")?.value || "",
    done: get("done")?.value || "",
    start: get("start")?.value || "",
    end: get("end")?.value || "",
    signTech: get("signTech")?.value || "",
    signClient: get("signClient")?.value || ""
  };

  const reportContent = document.getElementById("reportContent");
  if (reportContent) {
    reportContent.innerHTML = `
      <div style="font-family: Arial, sans-serif; padding: 20px; color: #000;">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #004080; padding-bottom: 10px;">
          <img src="logikart-logo.png" alt="LOGIKART" style="height: 50px;">
          <h2 style="text-align: center; flex-grow: 1; color: #004080;">Rapport d‚Äôintervention</h2>
          <div style="text-align: right; font-size: 12px;">${values.date}</div>
        </div>

        <div style="margin-top: 20px;">
          <p><strong>Ticket :</strong> ${values.ticket}</p>
          <p><strong>Adresse du site :</strong> ${values.site}</p>
          <p><strong>Nom du technicien :</strong> ${values.tech}</p>
        </div>

        <div style="margin-top: 20px;">
          <h4>Travail √† faire</h4>
          <div style="border: 1px solid #ccc; padding: 10px; min-height: 60px;">${values.todo}</div>
        </div>

        <div style="margin-top: 20px;">
          <h4>Travail effectu√©</h4>
          <div style="border: 1px solid #ccc; padding: 10px; min-height: 80px;">${values.done}</div>
        </div>

        <div style="margin-top: 20px;">
          <p><strong>Heure d‚Äôarriv√©e :</strong> ${values.start}</p>
          <p><strong>Heure de d√©part :</strong> ${values.end}</p>
        </div>
      </div>
    `;
  }

  populateTechnicianSuggestions();
}

function closeReportForm() {
  const modal = document.getElementById("reportModal");
  if (modal) modal.style.display = "none";
}

function generatePDF() {
  const form = document.getElementById("reportForm");
  const get = id => form.querySelector(`[name="${id}"]`);

  const values = {
    ticket: get("ticket").value,
    date: get("interventionDate").value,
    site: get("siteAddress").value,
    tech: get("technician").value,
    todo: get("todo").value,
    done: get("done").value,
    start: get("start").value,
    end: get("end").value,
    signTech: get("signTech").value,
    signClient: get("signClient").value
  };

  const reportContent = document.getElementById("reportContent");

  reportContent.innerHTML = `
    <div style="font-family: Arial, sans-serif; padding: 20px; color: #000;">
      <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #004080; padding-bottom: 10px;">
        <img src="logikart-logo.png" alt="LOGIKART" style="height: 50px;">
        <h2 style="text-align: center; flex-grow: 1; color: #004080;">Rapport d‚Äôintervention</h2>
        <div style="text-align: right; font-size: 12px;">${values.date}</div>
      </div>

      <div style="margin-top: 20px;">
        <p><strong>Ticket :</strong> ${values.ticket}</p>
        <p><strong>Adresse du site :</strong> ${values.site}</p>
        <p><strong>Nom du technicien :</strong> ${values.tech}</p>
      </div>

      <div style="margin-top: 20px;">
        <h4>Travail √† faire</h4>
        <div style="border: 1px solid #ccc; padding: 10px; min-height: 60px;">${values.todo}</div>
      </div>

      <div style="margin-top: 20px;">
        <h4>Travail effectu√©</h4>
        <div style="border: 1px solid #ccc; padding: 10px; min-height: 80px;">${values.done}</div>
      </div>

      <div style="margin-top: 20px;">
        <p><strong>Heure d‚Äôarriv√©e :</strong> ${values.start}</p>
        <p><strong>Heure de d√©part :</strong> ${values.end}</p>
      </div>
      
      <div style="margin-top: 20px; display: flex; justify-content: space-between;">
        <div style="width: 48%;">
          <p><strong>Signature du technicien :</strong></p>
          <div style="border: 1px solid #ccc; height: 60px;"></div>
          <p style="text-align: center; margin-top: 5px;">${values.signTech}</p>
        </div>

        <div style="width: 48%;">
          <p><strong>Signature du client :</strong></p>
          <div style="border: 1px solid #ccc; height: 60px;"></div>
          <p style="text-align: center; margin-top: 5px;">${values.signClient}</p>
        </div>
      </div>
    </div>
  `;

  reportContent.style.display = "block";

  const opt = {
    margin: 0.5,
    filename: 'rapport_intervention_LOGIKART.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opt).from(reportContent).save().then(() => {
    reportContent.style.display = "none";
    form.reset();
    closeReportForm();
  });
}

function populateTechnicianSuggestions() {
  const datalist = document.getElementById("technicianList");
  if (!datalist) return;

  datalist.innerHTML = "";
  const providers = JSON.parse(localStorage.getItem("providers")) || [];

  providers.forEach(p => {
    const option = document.createElement("option");
    option.value = `${p.firstName || ""} ${p.contactName || ""}`.trim();
    datalist.appendChild(option);
  });
}

// --- Itin√©raire --- (inchang√©)
function openItineraryTool() {
  const modal = document.getElementById("itineraryModal");
  if (!modal) return;
  modal.style.display = "flex";
  document.getElementById("routeResult").innerHTML = "";
}

function closeItineraryModal() {
  const modal = document.getElementById("itineraryModal");
  if (!modal) return;
  modal.style.display = "none";
  document.getElementById("itineraryForm").reset();
  document.getElementById("extraDestinations").innerHTML = "";
}

function addDestinationField() {
  const container = document.getElementById("extraDestinations");
  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "Destination suppl√©mentaire";
  input.classList.add("extra-destination");
  container.appendChild(input);
}

async function calculateRoute() {
  const start = document.getElementById("startAddress").value.trim();
  const end = document.getElementById("endAddress").value.trim();
  const extras = Array.from(document.getElementsByClassName("extra-destination")).map(input => input.value.trim()).filter(Boolean);

  const points = [start, ...extras, end];

  const coords = [];
  for (const address of points) {
    const data = await fetchNominatim(address);
    if (!data.length) {
      alert(`Adresse non trouv√©e : ${address}`);
      return;
    }
    coords.push([parseFloat(data[0].lon), parseFloat(data[0].lat)]); // ORS = [lon, lat]
  }

  const orsRes = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
    method: 'POST',
    headers: {
      'Authorization': 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImQ4YTg5NTg4NjE0OTQ5NjZhMDY3YzgxZjJjOGE3ODI3IiwiaCI6Im11cm11cjY0In0=',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      coordinates: coords,
      language: "fr",
      instructions: true
    })
  });

  if (!orsRes.ok) {
    alert("Erreur lors du calcul d‚Äôitin√©raire.");
    return;
  }

  const geojson = await orsRes.json();
  window.lastRouteInstructions = geojson.features[0].properties.segments[0].steps.map((step, i) => {
    return `${i + 1}. ${step.instruction} (${(step.distance / 1000).toFixed(2)} km)`;
  });

  if (window.routeLine) map.removeLayer(window.routeLine);
  window.routeLine = L.geoJSON(geojson, { style: { color: "blue", weight: 4 } }).addTo(map);
  map.fitBounds(window.routeLine.getBounds());

  const summary = geojson.features[0].properties.summary;
  const distanceKm = (summary.distance / 1000).toFixed(2);
  const durationMin = Math.round(summary.duration / 60);

  document.getElementById("routeResult").innerHTML = `
    <p>üìè Distance totale : <strong>${distanceKm} km</strong></p>
    <p>‚è±Ô∏è Dur√©e estim√©e : <strong>${durationMin} minutes</strong></p>
  `;
  document.getElementById("exportPdfBtn").style.display = "inline-block";
}

function exportItineraryToPDF() {
  const start = document.getElementById("startAddress").value.trim();
  const end = document.getElementById("endAddress").value.trim();
  const extras = Array.from(document.getElementsByClassName("extra-destination"))
    .map(input => input.value.trim()).filter(Boolean);
  const distanceText = document.querySelector("#routeResult").innerText;

  leafletImage(map, function (err, canvas) {
    if (err) {
      alert("Erreur lors du rendu de la carte.");
      return;
    }

    const mapImage = canvas.toDataURL("image/jpeg");

    const container = document.createElement("div");
    container.style.padding = "20px";
    container.style.fontFamily = "Arial";

    container.innerHTML = `
      <h2 style="color:#004080;">üß≠ Itin√©raire LOGIKART</h2>
      <p><strong>D√©part :</strong> ${start}</p>
      ${extras.map((dest, i) => `<p><strong>√âtape ${i + 1} :</strong> ${dest}</p>`).join("")}
      <p><strong>Arriv√©e :</strong> ${end}</p>
      <p style="margin-top:10px;">${distanceText.replace(/\\n/g, "<br>")}</p>
    `;

    if (window.lastRouteInstructions && window.lastRouteInstructions.length) {
      const instructionsHtml = window.lastRouteInstructions.map(i => `<li>${i}</li>`).join("");
      container.innerHTML += `
        <p><strong>üß≠ Instructions pas √† pas :</strong></p>
        <ol>${instructionsHtml}</ol>
      `;
    }

    container.innerHTML += `
      <hr>
      <p><strong>Carte de l‚Äôitin√©raire :</strong></p>
      <img src="${mapImage}" style="width:100%; max-height:500px; margin-top:10px;" />
    `;

    html2pdf().set({
      margin: 0.5,
      filename: 'itineraire_LOGIKART.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    }).from(container).save();
  });
}

// --- Exposer au scope global ---
window.searchNearest = searchNearest;
window.addProvider = addProvider;
window.hideForm = hideForm;
window.toggleProviderList = toggleProviderList;
window.openItineraryTool = openItineraryTool;
window.closeItineraryModal = closeItineraryModal;
window.addDestinationField = addDestinationField;
window.calculateRoute = calculateRoute;
window.exportItineraryToPDF = exportItineraryToPDF;
window.openReportForm = openReportForm;
window.closeReportForm = closeReportForm;
window.generatePDF = generatePDF;
window.editProvider = editProvider;
window.deleteProvider = async function(index) {
  const providers = JSON.parse(localStorage.getItem("providers")) || [];
  if (!confirm("Confirmer la suppression ?")) return;
  const toDelete = providers[index];
  try {
    if (toDelete?.id) {
      await db.collection("prestataires").doc(toDelete.id).delete();
    }
  } catch (e) {
    console.error("Erreur suppression Firestore :", e);
    alert("Suppression c√¥t√© serveur impossible.");
  }
};
window.exportProviders = exportProviders;
window.openImportModal = openImportModal;
window.closeImportModal = closeImportModal;
window.handleImport = handleImport;
window.refreshProvidersFromServer = refreshProvidersFromServer;
window.geocodeAndAddToMap = geocodeAndAddToMap;
"""

Path("/mnt/data/index.fixed.html").write_text(index_content, encoding="utf-8")
Path("/mnt/data/script.fixed.js").write_text(script_content, encoding="utf-8")

print("Saved files:\n- /mnt/data/index.fixed.html\n- /mnt/data/script.fixed.js")
